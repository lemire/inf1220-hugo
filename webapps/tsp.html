<div id="tsp-app-container" style="font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f7fafc; color: #2d3748; padding: 16px; display: flex; align-items: center; justify-content: center; isolation: isolate;">
    <div style="background-color: #ffffff; box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1); border-radius: 8px; padding: 24px; max-width: 960px; width: 100%; margin: 32px auto;">
        <h2 style="font-size: 24px; font-weight: bold; text-align: center; color: #2b6cb0; margin-bottom: 24px;">Problème du voyageur de commerce (TSP)</h2>

        <div style="margin-bottom: 24px;">
            <h3 style="font-size: 20px; font-weight: 600; color: #4a5568; margin-bottom: 12px;">Pseudocode (Approche du plus proche voisin)</h3>
            <pre id="tsp-pseudocode" style="background-color: #edf2f7; padding: 16px; border-radius: 6px; font-size: 14px; font-family: 'Courier New', Courier, monospace; color: #1a202c; overflow: auto; white-space: pre-wrap;">
Entrées :
  Liste de villes : villes[n]
  Matrice des distances : distances[n][n]

Sorties :
  Liste ordonnée des villes : trajet

Initialiser trajet comme une liste vide
Choisir une ville de départ aléatoire et l’ajouter à trajet
Marquer la ville de départ comme visitée
TANT QUE toutes les villes ne sont pas visitées FAIRE
    Trouver la ville non visitée la plus proche de la dernière ville dans trajet
    Ajouter cette ville à trajet
    Marquer cette ville comme visitée
FIN TANT QUE
Ajouter la ville de départ à la fin de trajet pour boucler
RETOURNER trajet, Distance totale
            </pre>
        </div>

        <div style="margin-bottom: 24px; overflow-x: auto;">
            <h3 style="font-size: 20px; font-weight: 600; color: #4a5568; margin-bottom: 12px;">Tableau des distances (km)</h3>
            <table id="tsp-distance-table" style="width: 100%; border-collapse: collapse; border-radius: 8px; overflow: hidden;">
                <thead>
                    <tr style="background-color: #2b6cb0; color: #ffffff;">
                        <th style="padding: 12px; border-right: 1px solid #2c5282; font-weight: 500;">Ville</th>
                        <th style="padding: 12px; border-right: 1px solid #2c5282; font-weight: 500;">Montréal</th>
                        <th style="padding: 12px; border-right: 1px solid #2c5282; font-weight: 500;">Québec</th>
                        <th style="padding: 12px; border-right: 1px solid #2c5282; font-weight: 500;">Laval</th>
                        <th style="padding: 12px; border-right: 1px solid #2c5282; font-weight: 500;">Gatineau</th>
                        <th style="padding: 12px; border-right: 1px solid #2c5282; font-weight: 500;">Longueuil</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="background-color: #f7fafc;">
                        <td style="padding: 8px; border: 1px solid #e2e8f0; font-weight: 500;">Montréal</td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">-</td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">250</td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">20</td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">200</td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">15</td>
                    </tr>
                    <tr style="background-color: #ffffff;">
                        <td style="padding: 8px; border: 1px solid #e2e8f0; font-weight: 500;">Québec</td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">250</td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">-</td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">240</td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">450</td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">245</td>
                    </tr>
                    <tr style="background-color: #f7fafc;">
                        <td style="padding: 8px; border: 1px solid #e2e8f0; font-weight: 500;">Laval</td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">20</td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">240</td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">-</td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">210</td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">30</td>
                    </tr>
                    <tr style="background-color: #ffffff;">
                        <td style="padding: 8px; border: 1px solid #e2e8f0; font-weight: 500;">Gatineau</td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">200</td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">450</td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">210</td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">-</td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">210</td>
                    </tr>
                    <tr style="background-color: #f7fafc;">
                        <td style="padding: 8px; border: 1px solid #e2e8f0; font-weight: 500;">Longueuil</td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">15</td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">245</td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">30</td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">210</td>
                        <td style="padding: 8px; border: 1px solid #e2e8f0;">-</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div style="display: flex; justify-content: center; gap: 16px; margin-bottom: 24px;">
            <button id="tsp-next-btn" style="padding: 12px 24px; background-color: #2b6cb0; color: #ffffff; font-weight: 600; border-radius: 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); border: none; cursor: pointer; transition: background-color 0.3s;">Commencer</button>
            <button id="tsp-reset-btn" style="padding: 12px 24px; background-color: #4a5568; color: #ffffff; font-weight: 600; border-radius: 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); border: none; cursor: pointer; transition: background-color 0.3s;">Réinitialiser</button>
        </div>

        <div style="background-color: #ebf8ff; padding: 16px; border-radius: 6px; border: 1px solid #bee3f8;">
            <h3 style="font-size: 18px; font-weight: 600; color: #2c5282; margin-bottom: 8px;">État actuel</h3>
            <p id="tsp-message" style="color: #1a202c; margin-bottom: 8px;">Cliquez sur 'Commencer' pour commencer l'initialisation.</p>
            <p id="tsp-step" style="color: #1a202c; margin-bottom: 8px;">Étape : 0</p>
            <p id="tsp-trajet" style="color: #1a202c; margin-bottom: 8px;">Trajet actuel : </p>
            <p id="tsp-distance" style="color: #1a202c;">Distance totale parcourue : 0 km</p>
        </div>
    </div>
</div>

<script>
    const TSPApp = (function () {
        const cities = ["Montréal", "Québec", "Laval", "Gatineau", "Longueuil"];
        const distances = [
            [0, 250, 20, 200, 15],
            [250, 0, 240, 450, 245],
            [20, 240, 0, 210, 30],
            [200, 450, 210, 0, 210],
            [15, 245, 30, 210, 0]
        ];

        let trajet = [];
        let visited = new Array(cities.length).fill(false);
        let currentIndex = -1;
        let startIndex = -1;
        let totalDistance = 0;
        let currentStep = 0;
        let isAlgorithmFinished = false;

        const pseudocodeLines = [
            "Entrées :",
            "  Liste de villes : villes[n]",
            "  Matrice des distances : distances[n][n]",
            "",
            "Sorties :",
            "  Liste ordonnée des villes : trajet",
            "",
            "Initialiser trajet comme une liste vide",              // Line 7
            "Choisir une ville de départ aléatoire et l’ajouter à trajet", // Line 8
            "Marquer la ville de départ comme visitée",          // Line 9
            "TANT QUE toutes les villes ne sont pas visitées FAIRE", // Line 10
            "    Trouver la ville non visitée la plus proche de la dernière ville dans trajet", // Line 11
            "    Ajouter cette ville à trajet",                  // Line 12
            "    Marquer cette ville comme visitée",             // Line 13
            "FIN TANT QUE",                                       // Line 14
            "Ajouter la ville de départ à la fin de trajet pour boucler", // Line 15
            "RETOURNER trajet, Distance totale"                 // Line 16
        ];

        const nextBtn = document.getElementById('tsp-next-btn');
        const resetBtn = document.getElementById('tsp-reset-btn');
        const messageEl = document.getElementById('tsp-message');
        const stepEl = document.getElementById('tsp-step');
        const trajetEl = document.getElementById('tsp-trajet');
        const distanceEl = document.getElementById('tsp-distance');
        const pseudocodeEl = document.getElementById('tsp-pseudocode');
        const table = document.getElementById('tsp-distance-table');

        function updatePseudocode() {
            // Mapping currentStep to pseudocode line numbers
            const stepToLine = {
                0: 7,  // Initialiser trajet comme une liste vide
                1: 8,  // Choisir une ville de départ aléatoire et l’ajouter à trajet
                2: 9,  // Marquer la ville de départ comme visitée
                3: 10, // TANT QUE toutes les villes ne sont pas visitées FAIRE
                4: 11, // Trouver la ville non visitée la plus proche...
                5: 12, // Ajouter cette ville à trajet
                6: 13, // Marquer cette ville comme visitée
                7: 15, // Ajouter la ville de départ à la fin de trajet pour boucler
                8: 16  // RETOURNER trajet, Distance totale
            };
            const activeLine = stepToLine[currentStep] || -1;
            pseudocodeEl.innerHTML = pseudocodeLines
                .map((line, index) => {
                    // Pseudocode lines are 0-indexed in the array, but 1-indexed in the display
                    if ((index + 1) === activeLine) {
                        return `<span style="background-color: #fefcbf; padding: 2px 4px; border-radius: 4px;">${line}</span>`;
                    }
                    return line;
                })
                .join('\n');
        }

        function updateTable() {
            const rows = table.querySelectorAll('tbody tr');
            const headers = table.querySelectorAll('thead th');
            if(currentIndex === -1) {
                // Si aucune ville n'est sélectionnée, on réinitialise les styles
                rows.forEach((row) => {
                    row.querySelectorAll('td').forEach((cell) => {
                        cell.style.backgroundColor = '';
                    });
                });
                headers.forEach((header) => {
                    header.style.backgroundColor = '#2b6cb0';
                });
                return;
            }


            // Surligner la ville courante (colonne et rangée)
            if (currentIndex !== -1 && !isAlgorithmFinished) {
                // En-tête de colonne
                if (headers[currentIndex + 1]) headers[currentIndex + 1].style.backgroundColor = '#9ae6b4';
                // Rangée courante
                if (rows[currentIndex]) {
                    rows[currentIndex].querySelectorAll('td').forEach((cell, colIndex) => {
                        cell.style.backgroundColor = '#fefcbf';
                    });
                }
                // Colonne courante dans chaque rangée
                rows.forEach((row, rowIndex) => {
                    const cell = row.querySelectorAll('td')[currentIndex + 1];
                    if (cell) cell.style.backgroundColor = '#fefcbf';
                });
            }
        }

        function initializeAlgorithm() {
            trajet = [];
            visited = new Array(cities.length).fill(false);
            currentIndex = -1;
            startIndex = -1;
            totalDistance = 0;
            currentStep = 0;
            isAlgorithmFinished = false;
            messageEl.textContent = "Cliquez sur 'Commencer' pour commencer l'initialisation.";
            stepEl.textContent = `Étape : 0`;
            trajetEl.textContent = `Trajet actuel : `;
            distanceEl.textContent = `Distance totale parcourue : 0 km`;
            nextBtn.textContent = "Commencer";
            nextBtn.disabled = false;
            updateTable();
            updatePseudocode();
        }

        function handleNextStep() {
            if (isAlgorithmFinished) {
                messageEl.textContent = `Algorithme terminé. Trajet final : ${trajet.join(" → ")}. Distance totale : ${totalDistance} km. Cliquez sur 'Réinitialiser' pour recommencer.`;
                nextBtn.disabled = true;
                return;
            }

            switch (currentStep) {
                case 0: // Initialiser trajet comme une liste vide
                    trajet = [];
                    visited = new Array(cities.length).fill(false);
                    messageEl.textContent = "Le trajet est initialisé. Prêt à choisir une ville de départ.";
                    currentStep = 1;
                    nextBtn.textContent = "Suivant";
                    break;
                case 1: // Choisir une ville de départ aléatoire et l’ajouter à trajet
                    startIndex = Math.floor(Math.random() * cities.length);
                    trajet.push(cities[startIndex]);
                    currentIndex = startIndex;
                    messageEl.textContent = `Ville de départ choisie aléatoirement : ${cities[startIndex]}.`;
                    currentStep = 2;
                    break;
                case 2: // Marquer la ville de départ comme visitée
                    visited[currentIndex] = true;
                    messageEl.textContent = `Ville de départ (${cities[currentIndex]}) marquée comme visitée.`;
                    currentStep = 3;
                    break;
                case 3: // TANT QUE toutes les villes ne sont pas visitées FAIRE
                    // This step is more of a check for the loop condition
                    if (trajet.length === cities.length) {
                        messageEl.textContent = "Toutes les villes ont été visitées. Ajout de la ville de départ pour boucler le trajet.";
                        currentStep = 7; // Jump to adding start city to loop
                    } else {
                        messageEl.textContent = "Toutes les villes ne sont pas encore visitées. Recherche de la ville la plus proche.";
                        currentStep = 4; // Proceed to find the nearest city
                    }
                    break;
                case 4: // Trouver la ville non visitée la plus proche de la dernière ville dans trajet
                    let minD = Infinity;
                    let nextCityIdx = -1;

                    for (let i = 0; i < cities.length; i++) {
                        if (!visited[i]) {
                            const distance = distances[currentIndex][i];
                            if (distance < minD) {
                                minD = distance;
                                nextCityIdx = i;
                            }
                        }
                    }

                    if (nextCityIdx === -1) {
                        messageEl.textContent = "Erreur: Aucune ville non visitée trouvée. L'algorithme est bloqué. Réinitialisez.";
                        isAlgorithmFinished = true;
                        nextBtn.textContent = "Terminé";
                        nextBtn.disabled = true;
                        break;
                    }
                    
                    // Store next city and distance temporarily for the next steps
                    nextBtn.dataset.nextCityIdx = nextCityIdx;
                    nextBtn.dataset.minD = minD;

                    messageEl.textContent = `La ville la plus proche de ${cities[currentIndex]} est ${cities[nextCityIdx]} (distance ${minD} km).`;
                    currentStep = 5; // Proceed to add this city
                    break;
                case 5: // Ajouter cette ville à trajet
                    const nextIdxToAdd = parseInt(nextBtn.dataset.nextCityIdx);
                    const distToAdd = parseInt(nextBtn.dataset.minD);

                    trajet.push(cities[nextIdxToAdd]);
                    totalDistance += distToAdd;
                    currentIndex = nextIdxToAdd; // Update current index after adding
                    
                    messageEl.textContent = `Ajout de ${cities[nextIdxToAdd]} au trajet. Distance cumulée : ${totalDistance} km.`;
                    currentStep = 6; // Proceed to mark as visited
                    break;
                case 6: // Marquer cette ville comme visitée
                    visited[currentIndex] = true;
                    messageEl.textContent = `Ville ${cities[currentIndex]} marquée comme visitée.`;
                    currentStep = 3; // Loop back to check "TANT QUE" condition
                    break;
                case 7: // Ajouter la ville de départ à la fin de trajet pour boucler
                    const returnDist = distances[currentIndex][startIndex];
                    trajet.push(cities[startIndex]);
                    totalDistance += returnDist;
                    messageEl.textContent = `Retour à la ville de départ (${cities[startIndex]}) pour boucler (distance ${returnDist} km).`;
                    currentStep = 8;
                    break;
                case 8: // RETOURNER trajet, Distance totale (Algorithm finished)
                    isAlgorithmFinished = true;
                    messageEl.textContent = `Algorithme terminé. Trajet final : ${trajet.join(" → ")}. Distance totale : ${totalDistance} km.`;
                    nextBtn.textContent = "Terminé";
                    nextBtn.disabled = true;
                    break;
                default:
                    messageEl.textContent = "État inconnu. Réinitialisation.";
                    initializeAlgorithm();
                    break;
            }

            // Update UI elements after each step
            stepEl.textContent = `Étape : ${currentStep}`;
            trajetEl.textContent = `Trajet actuel : ${trajet.join(" → ")}`;
            distanceEl.textContent = `Distance totale parcourue : ${totalDistance} km`;
            updateTable();
            updatePseudocode();
        }

        nextBtn.addEventListener('click', handleNextStep);
        resetBtn.addEventListener('click', initializeAlgorithm);

        initializeAlgorithm();

        return {
            initialize: initializeAlgorithm,
            nextStep: handleNextStep
        };
    })();
</script>